name: Publish Artifacts

on: pull_request

jobs:
  publish_artifacts:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
        architecture: x64
    - name: Check properties
      id: properties
      run: |
        ACTUAL_VERSION=$(grep -e "^VERSION_NAME=.*$" gradle.properties | cut -d= -f2)
        if [[ "$ACTUAL_VERSION" == *-SNAPSHOT ]]; then echo "::set-output name=is-snapshot::true"; else echo "::set-output name=is-snapshot::false"; fi
    - name: Updates when snapshot
      if: steps.properties.outputs.is-snapshot == 'true'
      run: |
        echo "apply from: 'https://raw.githubusercontent.com/arrow-kt/arrow/master/gradle/gradle-mvn-push.gradle'" >> gradle-plugin/build.gradle 
    - name: Publish Gradle Plugin
      if: steps.properties.outputs.is-snapshot == 'false'
      env:
        JAVA_OPTS: -Xms512m -Xmx1024m
        GRADLE_PUBLISH_KEY: ${{ secrets.GRADLE_PUBLISH_KEY }}
        GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}
      run: |
        echo "Publish Gradle Plugin in Gradle Plugins Portal ..."
        ./gradlew -Dgradle.publish.key=$GRADLE_PUBLISH_KEY -Dgradle.publish.secret=$GRADLE_PUBLISH_SECRET publishPlugins
